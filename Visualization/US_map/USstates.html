<!DOCTYPE html>

<!--

Author: Thomas van der Wardt
Student number: 10900578
File: uStates.html
External files: uStates.js, uStates.css, d3.v3.js
Last edited: 2-6-2015

-->
<html>
    <head>
        <title>US States</title>
		<link rel="stylesheet" type="text/css" href="USstates.css">
		<meta charset="UTF-8">
    </head>
<body>
<script src="d3.v3.js"></script>
<script src="topojson.v1.min.js"></script>
<script src="queue.v1.min.js"></script>
<script>
		var state_ids = ['AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI'
						,'ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN'
						,'MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH'
						,'OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA'
						,'WV','WI','WY']

		var q = queue(1);
			for (var i = 0; i < state_ids.length; i++){
				q.defer(d3.csv, "\\Data\\PVdata\\population_energy_growth\\solar_size\\solar_size_" + state_ids[i] + ".csv");
				q.defer(d3.csv, "\\Data\\PVdata\\population_energy_growth\\population_size\\" + state_ids[i] + "_population.csv");
			}
			
			q.awaitAll(drawMap);
			
		function drawMap(errors,allData){
			
			/* var allData = [ALdata,AKdata,AZdata,ARdata,CAdata,COdata,CTdata,DEdata,DCdata,
						FLdata,GAdata,HIdata,IDdata,ILdata,INdata,IAdata,KSdata,KYdata,LAdata,
						MEdata,MDdata,MAdata,MIdata,MNdata,MSdata,MOdata,MTdata,NEdata,NVdata,
						NHdata,NJdata,NMdata,NYdata,NCdata,NDdata,OHdata,OKdata,ORdata,PAdata,
						RIdata,SCdata,SDdata,TNdata,TXdata,UTdata,VTdata,VAdata,WAdata,WVdata,
						WIdata,WYdata]; */
			
			
			var width = 960,
				height = 500;

			var projection = d3.geo.albersUsa()
				.scale(1000)
				.translate([width / 2, height / 2]);

			var path = d3.geo.path()
				.projection(projection);

			var svg = d3.select("body").append("svg")
				.attr("width", width)
				.attr("height", height);

			d3.json("us.json", function(unitedState) {
				var data = topojson.feature(unitedState, unitedState.objects.states).features;
		
				// List of names connected to ids
				d3.csv("us-state-names.csv", function(csv){
					var nameCodes = {};
					var nameSize = {};
					var namePopulation = {};
					var x = 0;
					csv.forEach(function(d,i){
						nameCodes[d.id] = d.code;
						nameSize[d.code] = allData[x];
						namePopulation[d.code] = allData[x + 1];
						x += 2;
					});
					
					svg.append("g")
					.attr("class", "states-bundle")
					.selectAll("path")
					.data(data)
					.enter()
					.append("path")
					.attr("d", path)
					.attr("stroke", "black")
					.attr("class", function(d,i) { 
						return nameCodes[d.id];
					})
					.attr("fill", function(d,i) {
						if (nameSize[nameCodes[d.id]] != undefined){
							var size = parseFloat(nameSize[nameCodes[d.id]][5].Size);
							var population = parseFloat(namePopulation[nameCodes[d.id]][30].Population) * 1000000;
								
								
							// Find reference values: method #1 (% of max_size)
							var size_array = [];
							for (var i = 0; i < nameSize[nameCodes[d.id]].length; i++){
								size_array.push(parseInt(nameSize[nameCodes[d.id]][i].Size));
							}
							var max_size = Math.max.apply(null, size_array);
							var referencepopulation = parseFloat(namePopulation[nameCodes[d.id]][34].Population) * 1000000;
							var referenceSizePerCapita = parseFloat(max_size / referencepopulation);
							var sizePerCapita = parseFloat(size / population);
							var relativeAmount = parseFloat(sizePerCapita / referenceSizePerCapita);
							relativeAmount = parseFloat(size / max_size);
							
							
							if (isNaN(relativeAmount)){
								return "grey";
							} 
							// Reference values: method #2 (year growth)					
							var size_before = parseFloat(nameSize[nameCodes[d.id]][6].Size);
							var size_difference = parseFloat(size - size_before);
							var growth = parseFloat(size_difference / size_before);
									
							if (growth > 1){
								growth = 1;
							}	
							return d3.interpolate("#f7fcfd", "#00441b")(growth);	
						};
					});				
				});
			});

			d3.select(self.frameElement).style("height", height + "px"); 
		};

</script>
</body>
</html>